<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visit History</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Poppins", sans-serif;
        }

        body {
            min-height: 100vh;
            background: url('bg2.jpg') no-repeat;
            background-size: cover;
            background-position: center;
            padding: 20px;
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 20px 100px;
            background-color: white;
            display: flex;
            justify-content: space-between;
            z-index: 100;
        }

        .logo {
            font-size: 32px;
            color: black;
            text-decoration: none;
            font-weight: 700;
        }

        .navbar a {
            position: relative;
            font-size: 20px;
            color: black;
            font-weight: 500;
            text-decoration: none;
            margin-left: 50px;
            top: 8px;
        }

        .navbar a::before {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            width: 0;
            height: 2px;
            background: black;
        }

        .navbar a:hover::before {
            width: 100%;
            background-color: green;
        }

        .navbar a:hover {
            color: green;
        }

        .history-container {
            margin-top: 120px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .history-container h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .history-container ul {
            list-style-type: none;
            padding: 0;
        }

        .history-container ul li {
            background-color: #f9f9f9;
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 123, 255, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="#" class="logo">BOHR</a>
        <nav class="navbar">
            <a href="index.html">Home</a>
            <a href="#">About</a>
            <a href="map.html">Map</a>
            <a href="history.html">History</a>
        </nav>
    </header>

    <div class="history-container">
        <h1>Visit History</h1>
        <ul id="history-list"></ul>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Configuration
        const CONFIG = {
            GEOLOCATION: {
                WATCH_OPTIONS: {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 10000
                },
                UPDATE_INTERVAL: 1000, // 1 second
                PROXIMITY_THRESHOLD: 0.1 // 100 meters in km
            }
        };

        // Pinned locations
        const locations = [
            {
                lat: 13.7563,
                lng: 100.5018,
                title: "Bangkok",
                description: "City of Angels"
            },
            {
                lat: 13.825832971070632,
                lng: 100.57177728855734,
                title: "Ohio Inkjet",
                description: "Bu gaan Ban guu"
            },
            {
                lat: 34.0522,
                lng: -118.2437,
                title: "Los Angeles",
                description: "City of Angels"
            },
            {
                lat: 40.7128,
                lng: -74.0060,
                title: "New York",
                description: "The Big Apple"
            }
        ];

        // State
        const state = {
            updateInterval: null,
            lastUpdate: null
        };

        // Utility functions
        const utils = {
            getDistance(coord1, coord2) {
                const R = 6371;
                const dLat = (coord2.lat - coord1.lat) * (Math.PI / 180);
                const dLng = (coord2.lng - coord1.lng) * (Math.PI / 180);
                const a =
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(coord1.lat * (Math.PI / 180)) *
                    Math.cos(coord2.lat * (Math.PI / 180)) *
                    Math.sin(dLng / 2) * Math.sin(dLng / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            },

            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            },

            // Function to calculate time difference in hours and minutes
            getTimeSpent(entryTime, exitTime) {
                if (!entryTime || !exitTime) return "N/A";

                const entry = new Date(entryTime);
                const exit = new Date(exitTime);
                const diffInMs = exit - entry; // Difference in milliseconds

                const hours = Math.floor(diffInMs / (1000 * 60 * 60));
                const minutes = Math.floor((diffInMs % (1000 * 60 * 60)) / (1000 * 60));

                return `${hours}h ${minutes}m`;
            }
        };

        // Visit history management
        const visitHistory = {
            get() {
                try {
                    return JSON.parse(localStorage.getItem("visitHistory")) || [];
                } catch (e) {
                    console.error('Error reading visit history:', e);
                    return [];
                }
            },

            update(history) {
                try {
                    localStorage.setItem("visitHistory", JSON.stringify(history));
                    this.updateUI();
                } catch (e) {
                    console.error('Error saving visit history:', e);
                }
            },

            updateUI() {
                const history = this.get();
                const historyList = document.getElementById("history-list");
                historyList.innerHTML = history
                    .map(visit => `
                        <li>
                            <strong>${visit.title}</strong><br>
                            Arrival: ${visit.entryTime}<br>
                            Departure: ${visit.exitTime || "Still in location"}<br>
                            Time Spent: ${utils.getTimeSpent(visit.entryTime, visit.exitTime)}
                        </li>
                    `)
                    .join("");
            }
        };

        // Start location tracking
        function startLocationTracking() {
            if (navigator.geolocation) {
                state.updateInterval = setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        handleLocationUpdate,
                        handleLocationError,
                        CONFIG.GEOLOCATION.WATCH_OPTIONS
                    );
                }, CONFIG.GEOLOCATION.UPDATE_INTERVAL);
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }

        // Handle location update
        function handleLocationUpdate(position) {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            checkProximity(userLocation);
        }

        // Check proximity to pinned locations
        function checkProximity(userLocation) {
            const history = visitHistory.get();
            locations.forEach(location => {
                const distance = utils.getDistance(userLocation, location);
                const existingVisit = history.find(v => v.title === location.title && !v.exitTime);

                if (distance < CONFIG.GEOLOCATION.PROXIMITY_THRESHOLD) {
                    if (!existingVisit) {
                        // User entered the location
                        history.push({
                            title: location.title,
                            entryTime: new Date().toLocaleString(),
                            exitTime: null
                        });
                        visitHistory.update(history);
                        utils.showNotification(`You have entered ${location.title}`);
                    }
                } else if (existingVisit) {
                    // User left the location
                    existingVisit.exitTime = new Date().toLocaleString();
                    visitHistory.update(history);
                    utils.showNotification(`You have left ${location.title}`);
                }
            });
        }

        // Handle location error
        function handleLocationError(error) {
            console.error(`Error getting location: ${error.message}`);
        }

        // Initialize
        visitHistory.updateUI();
        startLocationTracking();
    </script>
</body>
</html>
